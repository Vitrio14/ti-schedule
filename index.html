<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheda Trasporto Infermi</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <link rel="icon" type="image/png" href="favicon.png">

    <style>
        :root {
            --emergency-red: #d32f2f;
            --dark-red: #9a0007;
            --success-green: #2e7d32;
            --glass-white: rgba(255, 255, 255, 0.95);
            --overlay: rgba(0, 0, 0, 0.7);
            --calendar-blue: #4285f4;
            --accent-glow: rgba(211, 47, 47, 0.3);
        }

        body { 
            font-family: 'Inter', 'Segoe UI', Roboto, sans-serif; 
            background: radial-gradient(circle at top left, #2c0000, #1a1a1a 50%, #000000);
            background-attachment: fixed;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            color: #333;
            min-height: 100vh;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='30' height='30' viewBox='0 0 30 30' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M15 0l15 15-15 15L0 15z' fill='%23ffffff' fill-opacity='0.02' fill-rule='evenodd'/%3E%3C/svg%3E");
            z-index: -1;
        }

        /* --- STILE PER IL LOGIN --- */
        #auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at top left, #2c0000, #000000);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast {
            background: #fff; color: #1a1a1a; padding: 14px 28px; border-radius: 16px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3); margin-bottom: 12px;
            animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            font-size: 0.95rem; font-weight: 600; border-left: 6px solid var(--emergency-red);
            display: flex; align-items: center; backdrop-filter: blur(10px);
        }
        .toast.success { border-left-color: var(--success-green); }
        .toast.info { border-left-color: #607d8b; }

        @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: scale(0.9); } }

        #confirm-modal, #fattura-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--overlay); backdrop-filter: blur(8px);
            display: none; justify-content: center; align-items: center; z-index: 3000;
        }
        
        /* Modal standard e largo per fattura */
        .modal-content {
            background: white; padding: 30px; border-radius: 24px; text-align: center;
            max-width: 320px; box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }
        .modal-content.large {
            max-width: 500px; width: 90%; text-align: left;
            max-height: 90vh; overflow-y: auto;
        }

        .app-card { 
            width: 100%; max-width: 580px; 
            background: var(--glass-white); border-radius: 28px; 
            box-shadow: 0 30px 60px rgba(0,0,0,0.6), inset 0 0 0 1px rgba(255,255,255,0.5);
            overflow: hidden; animation: fadeInUp 0.6s ease-out;
            margin-bottom: 30px;
        }

        .header {
            background: linear-gradient(135deg, var(--emergency-red), var(--dark-red));
            padding: 40px 20px; text-align: center; color: white;
            position: relative; overflow: hidden;
        }

        .header h1 { 
            margin: 0; font-size: 1.4rem; text-transform: uppercase; 
            letter-spacing: 3px; font-weight: 800; position: relative; z-index: 1;
        }

        .content { padding: 30px; }

        .section-label {
            font-size: 0.85rem; font-weight: 800; color: var(--emergency-red);
            text-transform: uppercase; margin: 35px 0 15px 0;
            display: flex; align-items: center; gap: 12px; letter-spacing: 1px;
        }
        .section-label::after { content: ""; flex: 1; height: 2px; background: linear-gradient(to right, #eee, transparent); }

        .input-group { margin-bottom: 18px; }
        label { display: block; font-size: 0.8rem; font-weight: 700; color: #555; margin-bottom: 6px; margin-left: 4px; }

        input, select, textarea { 
            width: 100%; padding: 14px; border: 2px solid #edf2f7; border-radius: 14px; 
            font-size: 1rem; box-sizing: border-box; background: #f8fafc;
            transition: all 0.3s ease; color: #2d3748;
            font-family: inherit;
        }

        input:focus, select:focus { border-color: var(--emergency-red); outline: none; background: #fff; }

        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .actions { margin-top: 40px; display: flex; flex-direction: column; gap: 12px; }

        button {
            padding: 18px; border: none; border-radius: 16px;
            font-size: 1.05rem; font-weight: 700; cursor: pointer; 
            transition: all 0.3s ease;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }

        .btn-gen { background: linear-gradient(135deg, var(--emergency-red), var(--dark-red)); color: white; }
        .btn-cal { background: white; color: var(--calendar-blue); border: 2px solid var(--calendar-blue); }
        .btn-invoice { background: #607d8b; color: white; }
        .btn-clear { background: transparent; color: #a0aec0; border: 2px dashed #cbd5e0; }
        .btn-logout { position: fixed; top: 10px; left: 10px; z-index: 4000; padding: 8px 15px; background: rgba(0,0,0,0.5); color: white; border-radius: 10px; border: none; font-size: 12px; cursor: pointer; }

        .archive-card {
            width: 100%; max-width: 580px; background: var(--glass-white);
            border-radius: 28px; padding: 25px; box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            margin-bottom: 50px; box-sizing: border-box;
        }
        .archive-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .archive-table th { text-align: left; font-size: 0.7rem; color: #718096; text-transform: uppercase; padding: 10px; border-bottom: 2px solid #edf2f7; }
        .archive-table td { padding: 12px 10px; font-size: 0.85rem; border-bottom: 1px solid #edf2f7; vertical-align: middle; }
        
        .action-cell { display: flex; gap: 6px; justify-content: flex-end; align-items: center; }
        .btn-table { 
            padding: 8px; border-radius: 10px; font-size: 0.75rem; 
            font-weight: 700; border: none; cursor: pointer;
            min-width: 38px; height: 38px; display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s;
        }
        .btn-table:active { transform: scale(0.9); }
        .btn-edit-arc { background: #3498db; color: white; }
        .btn-copy-arc { background: #2ecc71; color: white; }
        .btn-pdf { background: #e76a04; color: #4a5568; }
        .btn-del { background: #ff0000; color: #e53e3e; }

        .archive-scroll {
    max-height: 260px;
    overflow-y: auto;
    border-radius: 16px;
}


        @media (max-width: 480px) {
            .row { grid-template-columns: 1fr; }
            .archive-table th:nth-child(3), .archive-table td:nth-child(3) { display: none; }
        }
    </style>
</head>
<body>

<div id="auth-overlay">
    <div class="app-card" style="max-width: 350px;">
        <div class="header"><h1>Accesso</h1></div>
        <div class="content">
            <div class="input-group"><label>Email</label><input type="email" id="auth-email"></div>
            <div class="input-group"><label>Password</label><input type="password" id="auth-pass"></div>
            <button class="btn-gen" style="width:100%" onclick="handleLogin()">Entra</button>
            <p id="auth-error" style="color:red; font-size:12px; margin-top:10px; display:none; text-align:center;">Credenziali errate</p>
        </div>
    </div>
</div>

<button class="btn-logout" onclick="handleLogout()">Esci</button>
<div id="toast-container"></div>

<div id="confirm-modal">
    <div class="modal-content">
        <p id="modal-text" style="font-weight: 700; color: #1a202c; font-size: 1.1rem;">Vuoi procedere?</p>
        <div class="modal-btns" style="display:flex; gap:10px; margin-top:20px;">
            <button style="background: #f1f5f9; flex: 1; padding: 12px; border-radius: 12px;" onclick="closeConfirm(false)">Annulla</button>
            <button id="modal-confirm-btn" style="background: var(--emergency-red); color: white; flex: 1; padding: 12px; border-radius: 12px;" onclick="closeConfirm(true)">Conferma</button>
        </div>
    </div>
</div>

<div id="fattura-modal">
    <div class="modal-content large">
        <h3 style="color:var(--emergency-red); margin-top:0; text-align: center;">Dati Fatturazione</h3>
        <hr style="border:0; border-top:1px solid #eee; margin-bottom:15px;">
        
        <div class="row">
            <div class="input-group"><label>Missione</label><input type="text" id="f-missione" readonly style="background:#eee;"></div>
            <div class="input-group"><label>Data</label><input type="date" id="f-data" readonly style="background:#eee;"></div>
        </div>

        <div class="input-group"><label>Intestatario Fattura (Richiedente)</label><input type="text" id="f-nome"></div>
        <div class="input-group"><label>Paziente</label><input type="text" id="f-paziente"></div>
        <div class="input-group"><label>Indirizzo</label><input type="text" id="f-indirizzo"></div>
        
        <div class="row">
            <div class="input-group"><label>Citt√†</label><input type="text" id="f-citta"></div>
            <div class="input-group"><label>CAP</label><input type="text" id="f-cap"></div>
        </div>

        <div class="input-group"><label>Codice Fiscale</label><input type="text" id="f-cf"></div>

        <div class="row">
            <div class="input-group"><label>Email</label><input type="email" id="f-email"></div>
            <div class="input-group"><label>Cellulare</label><input type="text" id="f-cell"></div>
        </div>

        <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
        
        <div class="row">
            <div class="input-group"><label>Importo (‚Ç¨)</label><input type="number" id="f-prezzo"></div>
            <div class="input-group">
                <label>Metodo di Pagamento</label>
                <select id="f-pagamento">
                    <option value="Contanti">Contanti</option>
                    <option value="POS">POS</option>
                    <option value="Bonifico">Bonifico</option>
                </select>
            </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:20px;">
            <button style="background: #f1f5f9; flex:1; border-radius: 12px;" onclick="toggleFattura(false)">Annulla</button>
            <button style="background: var(--success-green); color:white; flex:1; border-radius: 12px;" onclick="saveRicevuta()">Salva Ricevuta</button>
        </div>
    </div>
</div>

<div class="app-card" id="main-card">
    <div class="header">
        <h1>Scheda Paziente</h1>
    </div>

    <div class="content">
        <form id="transportForm">
            <div class="section-label">üìã Dati Trasporto</div>
            <div class="row">
                <div class="input-group"><label>Missione</label><input type="text" id="missione"></div>
                <div class="input-group"><label>Data</label><input type="date" id="data"></div>
            </div>

            <div class="input-group"><label>Nome e cognome paziente</label><input type="text" id="paziente" placeholder="Mario Rossi"></div>
            
            <div class="row">
                <div class="input-group"><label>Anni</label><input type="number" id="anni"></div>
                <div class="input-group"><label>Corporatura (Kg)</label><input type="number" id="peso" placeholder="Peso"></div>
            </div>

            <div class="input-group">
                <label>Motivo trasporto</label>
                <select id="motivo">
                    <option value="">Seleziona...</option>
                    <option value="Ricovero">Ricovero</option>
                    <option value="Dimissione">Dimissione</option>
                    <option value="Visita di controllo A/R">Visita di controllo A/R</option>
                    <option value="Visita tra ospedali">Visita tra ospedali</option>
                    <option value="PSS">PSS</option>
                    <option value="Terapia iperbarica">Terapia iperbarica</option>
                </select>
            </div>

            <div class="input-group"><label>Patologia</label><input type="text" id="patologia"></div>
            <div class="input-group"><label>Partenza da</label><input type="text" id="partenza"></div>
            <div class="input-group"><label>Arrivo a</label><input type="text" id="arrivo"></div>

            <div class="row">
                <div class="input-group"><label>P.D.C. (Riferimento)</label><input type="text" id="pdc"></div>
                <div class="input-group"><label>Cellulare</label><input type="number" id="cell"></div>
            </div>
            <div class="input-group"><label>Email</label><input type="email" id="email"></div>

            <div class="section-label">üöë Team Assegnato</div>
            <div class="input-group"><label>Autista Soccorritore</label><input type="text" id="autista"></div>
            <div class="input-group"><label>1¬∞ Soccorritore</label><input type="text" id="soc1"></div>
            <div class="input-group"><label>2¬∞ Soccorritore</label><input type="text" id="soc2"></div>
            <div class="input-group"><label>3¬∞ Soccorritore</label><input type="text" id="soc3"></div>
            <div class="row">
                <div class="input-group"><label>Operatore SCU</label><input type="text" id="scu"></div>
                <div class="input-group"><label>Tirocinante</label><input type="text" id="tirocinante"></div>
            </div>

            <div class="section-label">‚è∞ Info Orarie</div>
            <div class="row">
                <div class="input-group"><label>Incontro in sede</label><input type="time" id="oreSede"></div>
                <div class="input-group"><label>Arrivo dal paziente</label><input type="time" id="orePaziente"></div>
            </div>
            <div class="input-group"><label>Arrivo a destinazione</label><input type="time" id="oreDestinazione"></div>

            <div class="section-label">üí≥ Logistica e Prezzo</div>
            <div class="input-group"><label>Mezzo assegnato</label><input type="text" id="mezzo"></div>
            <div class="row">
                <div class="input-group"><label>Prezzo (‚Ç¨)</label><input type="number" id="prezzo"></div>
                <div class="input-group">
                    <label>Pagamento</label>
                    <select id="pagamento">
                        <option value="">Metodo...</option>
                        <option value="Contanti">Contanti</option>
                        <option value="Bonifico">Bonifico</option>
                        <option value="POS">POS</option>
                    </select>
                </div>
            </div>
            <div class="input-group"><label>Prelevare dalla sede</label><input type="text" id="dpi"></div>

            <div class="input-group">
                <label>Sede che ha effettuato il trasporto</label>
                <select id="sedeTrasporto">
                    <option value="Taranto">Taranto</option>
                    <option value="Monteiasi">Monteiasi</option>
                </select>
            </div>
        </form>

        <div class="actions">
            <button class="btn-gen" onclick="generateAndSave()">‚ú® Salva Trasporto</button>
            <button class="btn-invoice" onclick="toggleFattura(true)">üßæ Dati Fatturazione</button>
            <button class="btn-cal" onclick="addToCalendar()">üìÖ Aggiungi a Calendar</button>
            <button class="btn-clear" onclick="triggerClear()">üóëÔ∏è Pulisci Scheda</button>
        </div>
    </div>
</div>

<div class="archive-card">
    <div class="section-label">üìÇ Archivio Trasporti</div>
    <div class="archive-scroll">
<table class="archive-table" id="archiveTable">

        <thead>
            <tr>
                <th style="width: 30%;">Missione</th>
                <th style="width: 25%;">Data</th>
                <th style="width: 15%;">Sede</th>
                <th style="width: 30%; text-align: right;">Azioni</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    </div>

<button onclick="loadMoreArchive()" class="btn-cal" style="width:100%; margin-top:10px;">
Mostra altri
</button>

</div>

<div class="archive-card">
    <div class="section-label">üìë Archivio Ricevute</div>
    <div class="archive-scroll">
<table class="archive-table" id="ricevuteTable">

        <thead>
            <tr>
                <th style="width: 25%;">Missione</th>
                <th style="width: 40%;">Richiedente</th>
                <th style="width: 15%;">Metodo</th>
                <th style="width: 20%; text-align: right;">Azioni</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    </div>

<button onclick="loadMoreRicevute()" class="btn-cal" style="width:100%; margin-top:10px;">
Mostra altre
</button>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
   import { getFirestore, collection, setDoc, getDocs, deleteDoc, doc, query, orderBy, getDoc, limit, startAfter } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    // IMPORT AUTH
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAHclgy-xpD-x0QdGzP0v61PGVjBFDstD8",
        authDomain: "calendar-ti-26bad.firebaseapp.com",
        projectId: "calendar-ti-26bad",
        storageBucket: "calendar-ti-26bad.firebasestorage.app",
        messagingSenderId: "822344269219",
        appId: "1:822344269219:web:b5d5f347e01e1f3cf3ae16",
        measurementId: "G-BBTR3D0ZCE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let archiveLastDoc = null;
let ricevuteLastDoc = null;
const PAGE_SIZE = 5;


    // --- GESTIONE LOGIN ---
    window.handleLogin = async () => {
        const email = document.getElementById('auth-email').value;
        const pass = document.getElementById('auth-pass').value;
        try {
            await signInWithEmailAndPassword(auth, email, pass);
            // Il listener onAuthStateChanged gestir√† la chiusura dell'overlay
        } catch (e) { 
            document.getElementById('auth-error').style.display = 'block';
        }
    };

    window.handleLogout = () => {
        signOut(auth).then(() => {
            window.location.reload();
        });
    };

    onAuthStateChanged(auth, (user) => {
        const overlay = document.getElementById('auth-overlay');
        if (user) {
            overlay.style.display = 'none';
            loadArchive();
            loadRicevute(); // Carica anche le ricevute
        } else {
            overlay.style.display = 'flex';
        }
    });

    // --- GESTIONE FATTURAZIONE (RICEVUTE) ---
    window.toggleFattura = (show) => {
        const modal = document.getElementById('fattura-modal');
        if (show) {
            // Controlla se c'√® almeno la missione
            const mainMissione = document.getElementById('missione').value;
            if(!mainMissione) {
                showToast("‚ö†Ô∏è Inserisci prima il numero missione nel form principale!", "info");
                return;
            }
            // Pre-compila i dati dal form principale
            document.getElementById('f-missione').value = mainMissione;
            document.getElementById('f-data').value = document.getElementById('data').value;
            document.getElementById('f-prezzo').value = document.getElementById('prezzo').value;
            
            // Prova a settare il metodo di pagamento se presente, altrimenti default
            const payMethod = document.getElementById('pagamento').value;
            if(payMethod && (payMethod === 'Contanti' || payMethod === 'POS' || payMethod === 'Bonifico')) {
                document.getElementById('f-pagamento').value = payMethod;
            }

            modal.style.display = 'flex';
        } else {
            modal.style.display = 'none';
        }
    };

    window.saveRicevuta = async () => {
        const miss = document.getElementById('f-missione').value;
        const dataR = {
            missione: miss,
            data: document.getElementById('f-data').value,
            paziente: document.getElementById('f-paziente').value,
            richiedente: document.getElementById('f-nome').value,
            indirizzo: document.getElementById('f-indirizzo').value,
            citta: document.getElementById('f-citta').value,
            cap: document.getElementById('f-cap').value,
            cf: document.getElementById('f-cf').value,
            email: document.getElementById('f-email').value,
            cell: document.getElementById('f-cell').value,
            importo: document.getElementById('f-prezzo').value,
            metodo: document.getElementById('f-pagamento').value, // Contanti, POS, Bonifico
            timestamp: new Date()
        };

        try {
            // Usa una collection diversa 'ricevute'
            await setDoc(doc(db, "ricevute", miss.replace(/\//g, "-")), dataR);
            showToast("‚úÖ Ricevuta salvata correttamente", "success");
            toggleFattura(false);
            loadRicevute();
        } catch (e) {
            showToast("‚ùå Errore salvataggio ricevuta", "info");
            console.error(e);
        }
    };

window.loadRicevute = async () => {
    const q = query(
        collection(db, "ricevute"),
        orderBy("timestamp", "desc"),
        limit(PAGE_SIZE)
    );

    const snap = await getDocs(q);
    const tbody = document.querySelector("#ricevuteTable tbody");
    tbody.innerHTML = "";

    snap.forEach((dDoc) => {
        ricevuteLastDoc = dDoc;
        const r = dDoc.data();

        const row = `<tr>
            <td>${r.missione}</td>
            <td>${r.richiedente}</td>
            <td>${r.metodo}</td>
            <td>
<div class="action-cell">
    <button class="btn-table btn-copy-arc" onclick="copyRicevutaText('${dDoc.id}')">üìã</button>
    <button class="btn-table btn-pdf" onclick="downloadRicevutaPDF('${dDoc.id}')">üìÑ</button>
    <button class="btn-table btn-del" onclick="triggerDeleteRicevuta('${dDoc.id}')">üóëÔ∏è</button>
</div>

            </td>
        </tr>`;

        tbody.insertAdjacentHTML('beforeend', row);
    });
};


window.loadMoreRicevute = async () => {
    if (!ricevuteLastDoc) return;

    const q = query(
        collection(db, "ricevute"),
        orderBy("timestamp", "desc"),
        startAfter(ricevuteLastDoc),
        limit(PAGE_SIZE)
    );

    const snap = await getDocs(q);
    const tbody = document.querySelector("#ricevuteTable tbody");

    snap.forEach((dDoc) => {
        ricevuteLastDoc = dDoc;
        const r = dDoc.data();

        const row = `<tr>
            <td>${r.missione}</td>
            <td>${r.richiedente}</td>
            <td>${r.metodo}</td>
            <td>
<div class="action-cell">
    <button class="btn-table btn-copy-arc" onclick="copyRicevutaText('${dDoc.id}')">üìã</button>
    <button class="btn-table btn-pdf" onclick="downloadRicevutaPDF('${dDoc.id}')">üìÑ</button>
    <button class="btn-table btn-del" onclick="triggerDeleteRicevuta('${dDoc.id}')">üóëÔ∏è</button>
</div>

            </td>
        </tr>`;

        tbody.insertAdjacentHTML('beforeend', row);
    });
};


window.deleteRicevuta = async (id) => {
    try {
        await deleteDoc(doc(db, "ricevute", id));
        showToast("üóëÔ∏è Ricevuta eliminata", "info");
        loadRicevute();
    } catch (e) {
        showToast("‚ùå Errore eliminazione ricevuta", "info");
    }
};


    window.copyRicevutaText = async (id) => {
        try {
            const snap = await getDoc(doc(db, "ricevute", id));
            if(snap.exists()) {
                const r = snap.data();
                const text = `*DATI FATTURAZIONE*
Missione: ${r.missione}
Nome paziente: ${r.paziente}
Data: ${r.data}
Richiedente: ${r.richiedente}
Indirizzo: ${r.indirizzo}
Citt√†: ${r.citta} (${r.cap})
CF: ${r.cf}
Email: ${r.email}
Cell: ${r.cell}
----------------
Importo: ‚Ç¨ ${r.importo}
Pagamento: ${r.metodo}`;
                await navigator.clipboard.writeText(text);
                showToast("üìã Dati fatturazione copiati!", "success");
            }
        } catch(e) { showToast("‚ùå Errore copia", "info"); }
    };

    // --- FINE GESTIONE FATTURAZIONE ---

    window.copyArchiveText = async (id) => {
        try {
            const docRef = doc(db, "trasporti", id);
            const snap = await getDoc(docRef);
            if (snap.exists()) {
                const text = window.formatDataToText(snap.data());
                await navigator.clipboard.writeText(text);
                showToast("üìã Messaggio copiato!", "success");
            }
        } catch (e) { showToast("‚ùå Errore durante la copia", "info"); }
    };

    window.loadToForm = async (id) => {
        try {
            showToast("‚è≥ Caricamento...", "info");
            const docRef = doc(db, "trasporti", id);
            const snap = await getDoc(docRef);
            if (snap.exists()) {
                const data = snap.data();
                const fields = [
                    'missione', 'data', 'paziente', 'anni', 'peso', 'motivo', 'patologia', 
                    'partenza', 'arrivo', 'pdc', 'cell', 'email', 'autista', 'soc1', 
                    'soc2', 'soc3', 'scu', 'tirocinante', 'oreSede', 'orePaziente', 
                    'oreDestinazione', 'mezzo', 'prezzo', 'pagamento', 'dpi'
                ];
                fields.forEach(f => {
                    const el = document.getElementById(f);
                    if(el) el.value = data[f] || "";
                });
                
                if(document.getElementById('sedeTrasporto')) {
                    document.getElementById('sedeTrasporto').value = data.sede || "Taranto";
                }
                
                showToast("üìÇ Dati caricati nella scheda!", "success");
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        } catch (e) { showToast("‚ùå Errore nel caricamento", "info"); }
    };

    window.generateAndSave = async () => {
        const v = (id) => document.getElementById(id).value;
        const missioneId = v('missione');
        if(!missioneId || !v('data')) { showToast("‚ö†Ô∏è Compila tutti i dati", "info"); return; }

        const dataDoc = {
            missione: missioneId, data: v('data'), paziente: v('paziente'), anni: v('anni'), peso: v('peso'),
            motivo: v('motivo'), patologia: v('patologia'), partenza: v('partenza'), arrivo: v('arrivo'),
            pdc: v('pdc'), cell: v('cell'), email: v('email'), autista: v('autista'), soc1: v('soc1'),
            soc2: v('soc2'), soc3: v('soc3'), scu: v('scu'), tirocinante: v('tirocinante'),
            oreSede: v('oreSede'), orePaziente: v('orePaziente'), oreDestinazione: v('oreDestinazione'),
            mezzo: v('mezzo'), prezzo: v('prezzo'), pagamento: v('pagamento'), dpi: v('dpi'),
            sede: v('sedeTrasporto'), timestamp: new Date()
        };

        try {
            const customId = missioneId.replace(/\//g, "-");
            await setDoc(doc(db, "trasporti", customId), dataDoc);
            showToast("‚úÖ Salvato nell'archivio", "success");
            loadArchive();
        } catch (e) { showToast("‚ùå Errore Database", "info"); }
    };

    window.deleteEntry = async (id) => {
    try {
        await deleteDoc(doc(db, "trasporti", id));
        showToast("üóëÔ∏è Trasporto eliminato", "info");
        loadArchive();
    } catch (e) {
        console.error(e);
        showToast("‚ùå Errore eliminazione", "info");
    }
};


window.loadArchive = async () => {
    const q = query(
        collection(db, "trasporti"),
        orderBy("timestamp", "desc"),
        limit(PAGE_SIZE)
    );

    const snap = await getDocs(q);
    const tbody = document.querySelector("#archiveTable tbody");
    tbody.innerHTML = "";

    snap.forEach((dDoc) => {
        archiveLastDoc = dDoc;
        const data = dDoc.data();

        const row = `<tr>
            <td><strong style="color:var(--emergency-red)">${data.missione}</strong></td>
            <td>${formatDateIta(data.data)}</td>
            <td>${data.sede}</td>
            <td>
<div class="action-cell">
    <button class="btn-table btn-edit-arc" onclick="loadToForm('${dDoc.id}')">‚úèÔ∏è</button>
    <button class="btn-table btn-copy-arc" onclick="copyArchiveText('${dDoc.id}')">üìã</button>
    <button class="btn-table btn-pdf" onclick="downloadPDF('${dDoc.id}')">üìÑ</button>
    <button class="btn-table btn-del" onclick="triggerDelete('${dDoc.id}')">üóëÔ∏è</button>
</div>

            </td>
        </tr>`;

        tbody.insertAdjacentHTML('beforeend', row);
    });
};

window.downloadRicevutaPDF = async (id) => {
    showToast("‚è≥ Generazione PDF ricevuta...", "info");

    const snap = await getDoc(doc(db, "ricevute", id));
    if (!snap.exists()) return;

    const r = snap.data();
    const f = (v) => (v && v !== "") ? v : "---";

    const pdfDiv = document.createElement("div");
    Object.assign(pdfDiv.style, {
        width: "794px",
        height: "1115px",
        padding: "35px",
        background: "#fff",
        fontFamily: "Arial, sans-serif",
        position: "fixed",
        top: "0",
        left: "0",
        zIndex: "-9999",
        boxSizing: "border-box"
    });

    pdfDiv.innerHTML = `
        <div style="border:3px solid #607d8b; padding:30px; height:100%; box-sizing:border-box;">
            <h1 style="color:#607d8b; margin-top:0;">Ricevuta di Trasporto</h1>

            <p><b>Missione:</b> ${f(r.missione)}</p>
            <p><b>Data:</b> ${formatDateIta(r.data)}</p>

            <hr>

            <h3>Dati Intestatario</h3>
            <p><b>Richiedente:</b> ${f(r.richiedente)}</p>
            <p><b>Paziente:</b> ${f(r.paziente)}</p>
            <p><b>Indirizzo:</b> ${f(r.indirizzo)}</p>
            <p><b>Citt√†:</b> ${f(r.citta)} (${f(r.cap)})</p>
            <p><b>Codice Fiscale:</b> ${f(r.cf)}</p>
            <p><b>Email:</b> ${f(r.email)}</p>
            <p><b>Cellulare:</b> ${f(r.cell)}</p>

            <hr>

            <h3>Pagamento</h3>
            <p style="font-size:18px;"><b>Importo:</b> ‚Ç¨ ${f(r.importo)}</p>
            <p><b>Metodo:</b> ${f(r.metodo)}</p>

            <div style="margin-top:40px; font-size:11px; color:#666; text-align:right;">
                Generato il ${new Date().toLocaleString("it-IT")}
            </div>
        </div>
    `;

    document.body.appendChild(pdfDiv);
    await new Promise(r => setTimeout(r, 300));

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("p", "mm", "a4");

    await pdf.html(pdfDiv, {
        callback: (doc) => {
            doc.save(`Ricevuta_${f(r.missione)}.pdf`);
            document.body.removeChild(pdfDiv);
            showToast("‚úÖ PDF Ricevuta generato", "success");
        },
        x: 0,
        y: 0,
        width: 210,
        windowWidth: 794,
        autoPaging: false,
        html2canvas: {
            scale: 0.2645,
            backgroundColor: "#ffffff"
        }
    });
};



window.loadMoreArchive = async () => {
    if (!archiveLastDoc) return;

    const q = query(
        collection(db, "trasporti"),
        orderBy("timestamp", "desc"),
        startAfter(archiveLastDoc),
        limit(PAGE_SIZE)
    );

    const snap = await getDocs(q);
    const tbody = document.querySelector("#archiveTable tbody");

    snap.forEach((dDoc) => {
        archiveLastDoc = dDoc;
        const data = dDoc.data();

        const row = `<tr>
            <td><strong style="color:var(--emergency-red)">${data.missione}</strong></td>
            <td>${formatDateIta(data.data)}</td>
            <td>${data.sede}</td>
            <td>
<div class="action-cell">
    <button class="btn-table btn-edit-arc" onclick="loadToForm('${dDoc.id}')">‚úèÔ∏è</button>
    <button class="btn-table btn-copy-arc" onclick="copyArchiveText('${dDoc.id}')">üìã</button>
    <button class="btn-table btn-pdf" onclick="downloadPDF('${dDoc.id}')">üìÑ</button>
    <button class="btn-table btn-del" onclick="triggerDelete('${dDoc.id}')">üóëÔ∏è</button>
</div>

            </td>
        </tr>`;

        tbody.insertAdjacentHTML('beforeend', row);
    });
};


window.downloadPDF = async (id) => {
    showToast("‚è≥ Ottimizzazione pagina singola...", "info");
    const docRef = doc(db, "trasporti", id);
    const snap = await getDoc(docRef);
    if (!snap.exists()) return;
    
    const d = snap.data();
    const f = (val) => (val && val !== "") ? val : "---";
    const dataIt = d.data ? formatDateIta(d.data) : '---';

    const pdfDiv = document.createElement('div');
    Object.assign(pdfDiv.style, {
        width: '794px', 
        height: '1115px', 
        padding: '35px',
        background: '#fff',
        fontFamily: 'Arial, sans-serif',
        position: 'fixed',
        top: '0',
        left: '0',
        zIndex: '-9999',
        boxSizing: 'border-box',
        color: '#000'
    });

    pdfDiv.innerHTML = `
        <div style="border: 3px solid #d32f2f; height: 100%; padding: 25px; border-radius: 10px; box-sizing: border-box; display: flex; flex-direction: column; background: white;">
            
            <table style="width: 100%; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px;">
                <tr>
                    <td style="text-align: left;">
                        <h1 style="margin:0; color:#d32f2f; font-size: 24px; text-transform: uppercase;">Scheda Trasporto Infermi</h1>
                        <p style="margin: 5px 0; font-weight: bold; color: #444;">Sede: ${f(d.sede)}</p>
                    </td>
                    <td style="text-align: right; vertical-align: top;">
                        <p style="margin:0; font-size: 15px;"><b>Missione N¬∞:</b> ${f(d.missione)}</p>
                        <p style="margin:5px 0 0 0; font-size: 15px;"><b>Data:</b> ${dataIt}</p>
                    </td>
                </tr>
            </table>

            <table style="width: 100%; border-collapse: collapse; table-layout: fixed; flex-grow: 1;">
                <tr>
                    <td style="width: 50%; vertical-align: top; padding-right: 20px;">
                        <h3 style="background:#f8f9fa; padding:8px; border-left:5px solid #d32f2f; font-size:14px; margin-top:0;">DATI PAZIENTE</h3>
                        <div style="font-size: 13px; line-height: 1.7;">
                            <p><b>Paziente:</b> ${f(d.paziente)}</p>
                            <p><b>Et√†:</b> ${f(d.anni)} anni | <b>Peso:</b> ${f(d.peso)} kg</p>
                            <p><b>Motivo:</b> ${f(d.motivo)}</p>
                            <p><b>Patologia:</b> ${f(d.patologia)}</p>
                            <div style="margin: 15px 0; padding: 12px; background: #fff5f5; border-radius: 8px; border: 1px solid #ffcccc;">
                                <b>DA:</b> ${f(d.partenza)}<br>
                                <b>A:</b> ${f(d.arrivo)}
                            </div>
                            <p><b>P.D.C.:</b> ${f(d.pdc)}</p>
                            <p><b>Contatti:</b> ${f(d.cell)}</p>
                            <p><b>Email:</b> ${f(d.email)}</p>
                        </div>
                    </td>
                    <td style="width: 50%; vertical-align: top; padding-left: 20px; border-left: 1px solid #eee;">
                        <h3 style="background:#f8f9fa; padding:8px; border-left:5px solid #d32f2f; font-size:14px; margin-top:0;">EQUIPAGGIO</h3>
                        <div style="font-size: 13px; line-height: 1.5;">
                            <p><b>Autista:</b> ${f(d.autista)}</p>
                            <p><b>1¬∞ Soccorritore:</b> ${f(d.soc1)}</p>
                            <p><b>2¬∞ Soccorritore:</b> ${f(d.soc2)}</p>
                            <p><b>3¬∞ Soccorritore:</b> ${f(d.soc3)}</p>
                            <p><b>SCU/Tirocinante:</b> ${f(d.scu)} / ${f(d.tirocinante)}</p>
                            <hr style="border: 0; border-top: 1px solid #eee; margin: 12px 0;">
                            <p><b>Mezzo:</b> ${f(d.mezzo)}</p>
                            <p><b>DPI da prelevare:</b> ${f(d.dpi)}</p>
                            <p style="font-size: 18px; color: #2e7d32; font-weight: bold; margin-top: 10px;">Prezzo: ‚Ç¨ ${f(d.prezzo)}</p>
                            <p style="font-size: 12px; color: #666;">Metodo: ${f(d.pagamento)}</p>
                        </div>
                    </td>
                </tr>
            </table>

            <div style="margin-top: 20px;">
                <table style="width: 100%; text-align: center; border-spacing: 10px;">
                    <tr>
                        <td style="background: #f1f3f5; padding: 12px; border-radius: 8px; width: 33%;">
                            <span style="font-size: 10px; color: #666; text-transform: uppercase;">In Sede</span><br>
                            <b style="font-size: 16px;">${f(d.oreSede)}</b>
                        </td>
                        <td style="background: #f1f3f5; padding: 12px; border-radius: 8px; width: 33%;">
                            <span style="font-size: 10px; color: #666; text-transform: uppercase;">Dal Paziente</span><br>
                            <b style="font-size: 16px;">${f(d.orePaziente)}</b>
                        </td>
                        <td style="background: #f1f3f5; padding: 12px; border-radius: 8px; width: 33%;">
                            <span style="font-size: 10px; color: #666; text-transform: uppercase;">Arrivo Dest.</span><br>
                            <b style="font-size: 16px;">${f(d.oreDestinazione)}</b>
                        </td>
                    </tr>
                </table>
            </div>

<div style="margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 15px; font-size: 11px; color: #444; line-height: 1.4;">
    <b style="color: #000;">NOTE IMPORTANTI:</b>
    <ul style="margin: 8px 0; padding-left: 15px;">
        <li><b>Dotazione:</b> Obbligatoria divisa completa e scarpe antinfortunistiche.</li>
        <li><b>Check-list:</b> Da effettuare sul mezzo tassativamente prima della partenza.</li>
        <li><b>Tariffazione:</b> Dopo la 1¬™ ora, aggiungere ‚Ç¨20,00 per ogni ora di attesa al totale.</li>
        <li><b>Fatturazione:</b> Si ricorda di compilare i dati di fatturazione sul portale fornito.</li>
        <li><b>Chiusura:</b> Fotografare il foglio di marcia e inviarlo in chat a fine servizio.</li>
        <li><b>Comunicazioni:</b> Segnalare tempestivamente variazioni o anomalie in chat o ai referenti.</li>
        <li><b>Privacy:</b> I dati sono sensibili; cancellare eventuali foto/info dal cellulare a fine servizio.</li>
    </ul>
    <p style="margin-top: 10px; font-weight: bold;">Grazie per la collaborazione e il servizio svolto.</p>
    
    <div style="text-align: right; margin-top: 10px; font-style: italic; color: #666;">
        Generato il: ${new Date().toLocaleString('it-IT')}
    </div>
</div>
    `;

    document.body.appendChild(pdfDiv);
    await new Promise(r => setTimeout(r, 400));

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');

    try {
        await pdf.html(pdfDiv, {
            callback: function(doc) {
                // Rimuove eventuali pagine extra create per errore
                const pageCount = doc.internal.getNumberOfPages();
                if (pageCount > 1) {
                    doc.deletePage(pageCount);
                }
                doc.save(`Missione_${f(d.missione)}.pdf`);
                document.body.removeChild(pdfDiv);
                showToast("‚úÖ PDF Generato (Pagina Singola)", "success");
            },
            x: 0,
            y: 0,
            width: 210,
            windowWidth: 794,
            autoPaging: false,
            html2canvas: {
                scale: 0.2645,
                useCORS: true,
                backgroundColor: '#ffffff'
            }
        });
    } catch (e) {
        console.error(e);
        document.body.removeChild(pdfDiv);
    }
};
    // Non carichiamo l'archivio subito, aspettiamo il login
    // window.onload = loadArchive; 
</script>

<script>
    let currentModalAction = null;

    function showToast(message, type = 'default') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerText = message;
        container.appendChild(toast);
        setTimeout(() => { 
            toast.style.animation = 'fadeOut 0.5s ease forwards';
            setTimeout(() => toast.remove(), 500); 
        }, 3000);
    }

    function triggerClear() {
        document.getElementById('modal-text').innerText = "Vuoi svuotare tutta la scheda?";
        currentModalAction = 'clear';
        document.getElementById('confirm-modal').style.display = 'flex';
    }

    function triggerDelete(id) {
        document.getElementById('modal-text').innerText = "Eliminare definitivamente questo trasporto?";
        currentModalAction = { type: 'delete', id: id };
        document.getElementById('confirm-modal').style.display = 'flex';
    }

    function triggerDeleteRicevuta(id) {
    document.getElementById('modal-text').innerText = "Eliminare definitivamente questa ricevuta?";
    currentModalAction = { type: 'deleteRicevuta', id: id };
    document.getElementById('confirm-modal').style.display = 'flex';
}


    function closeConfirm(confirmed) {
        document.getElementById('confirm-modal').style.display = 'none';
        if (confirmed && currentModalAction) {
            if (currentModalAction === 'clear') {
                document.getElementById('transportForm').reset();
                showToast("üßπ Scheda pulita", "info");
            } else if (currentModalAction.type === 'delete') {
                window.deleteEntry(currentModalAction.id);
                
            }
            else if (currentModalAction.type === 'deleteRicevuta') {
    window.deleteRicevuta(currentModalAction.id);
}

        }
        currentModalAction = null;
    }

    function formatDateIta(dateStr) {
        if (!dateStr || dateStr === "---") return "---";
        const parts = dateStr.split('-');
        if(parts.length !== 3) return dateStr;
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
    }

    window.formatDataToText = (d) => {
        const v = (key) => d[key] || "---";
        return `*DATI TRASPORTO*
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
*Sede Operativa:* ${v('sede')}
*Missione:* ${v('missione')}
*Data:* ${formatDateIta(d.data)}
*Nome e cognome paziente:* ${v('paziente')}
*Anni:* ${v('anni')}
*Corporatura:* ${v('peso')} Kg.
*Motivo trasporto:* ${v('motivo')}
*Patologia:* ${v('patologia')}
*Partenza da:* ${v('partenza')}
*Arrivo a:* ${v('arrivo')}
*P.D.C.:* ${v('pdc')}
*Cell:* ${v('cell')}
*Email:* ${v('email')}

*TEAM*
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
*Autista Soccorritore:* ${v('autista')}
*1¬∞ Soccorritore:* ${v('soc1')}
*2¬∞ Soccorritore:* ${v('soc2')}
*3¬∞ Soccorritore:* ${v('soc3')}
*Operatore SCU:* ${v('scu')}
*Tirocinante:* ${v('tirocinante')}

*INFO UTILI*
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
*Incontro in sede ore:* ${v('oreSede')}
*Arrivo dal paziente ore:* ${v('orePaziente')}
*Arrivo a destinazione ore:* ${v('oreDestinazione')}

*LOGISTICA E PREZZO*
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
*Mezzo assegnato:* ${v('mezzo')}
*Prezzo concordato:* ${v('prezzo')} ‚Ç¨
*Modalit√† di pagamento:* ${v('pagamento')}
*Prelevare dalla sede:* ${v('dpi')}

*NOTE IMPORTANTI*
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
- Per effettuare il servizio sar√† necessaria la divisa completa e scarpe antinfortunistiche.
- Effettuare la check list del mezzo prima della partenza.
- Dopo la 1¬™ ora di servizio bisogner√† aggiungere al totale del prezzo del trasporto, ‚Ç¨20,00 per ogni ora di attesa.
- Portare il foglio per la fatturazione che potete trovare in ambulanza o nella cartellina rossa presente nell'armadietto nel corridoio.
- Il team √® responsabile della compilazione corretta del foglio di fatturazione, che dovr√† poi lasciare ai ragazzi del servizio civile in comitato.
- Fotografare il foglio di marcia e inviarlo in chat a fine servizio.
- Si chiede nel caso in cui ci fossero variazioni o eventi anomali, di segnalarli tempestivamente in questa chat o contattare i referenti del servizio.
- Si ricorda che i dati postati in questa chat sono sensibili, si chiede post servizio, di provvedere alla cancellazione nel caso in cui rimangano memorizzati nel vostro cellulare.
- Grazie per la collaborazione e il servizio svolto.`;
    };

    function addToCalendar() {
        const v = (id) => document.getElementById(id).value;
        if (!v('data') || !v('oreSede')) { showToast("‚ö†Ô∏è Compila tutti i dati", "info"); return; }
        const currentData = {
            sede: v('sedeTrasporto'), missione: v('missione'), data: v('data'), paziente: v('paziente'),
            anni: v('anni'), peso: v('peso'), motivo: v('motivo'), patologia: v('patologia'),
            partenza: v('partenza'), arrivo: v('arrivo'), pdc: v('pdc'), cell: v('cell'), email: v('email'),
            autista: v('autista'), soc1: v('soc1'), soc2: v('soc2'), soc3: v('soc3'), scu: v('scu'), tirocinante: v('tirocinante'),
            oreSede: v('oreSede'), orePaziente: v('orePaziente'), oreDestinazione: v('oreDestinazione'),
            mezzo: v('mezzo'), prezzo: v('prezzo'), pagamento: v('pagamento'), dpi: v('dpi')
        };
        const text = window.formatDataToText(currentData);
        const dataGoogle = v('data').replace(/-/g, '');
        const titoli = encodeURIComponent(`${v('missione')} - ${v('paziente')}`);
        const calUrl = `https://www.google.com/calendar/render?action=TEMPLATE&text=${titoli}&dates=${dataGoogle}T${v('oreSede').replace(':','')}00/${dataGoogle}T235900&details=${encodeURIComponent(text)}`;
        window.open(calUrl, '_blank');
    }
</script>

</body>
</html>
